---
import type { Region } from '../config/site';
import { PRICING, REGIONS } from '../config/site';
import Button from './Button.astro';

import { getBasePath } from '../utils/basePath';

interface Props {
  region: Region;
}

const { region } = Astro.props;
const pricing = PRICING[region];
const { currencySymbol } = REGIONS[region];
const basePath = getBasePath();

// Mark the middle tier (Custom Website) as most popular
const popularIndex = 1;
---

<section class="py-20 bg-bg-base relative section-fade-in">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="text-center mb-16">
      <h2 class="text-3xl md:text-4xl font-bold font-heading text-text-primary mb-4">
        Straightforward pricing for serious websites.
      </h2>
      <p class="text-xl text-text-secondary">
        Choose the package that fits your business
      </p>
    </div>
    
    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6 max-w-7xl mx-auto icon-list">
      {pricing.map((tier, index) => (
        <div class:list={[
          'glass rounded-2xl p-8 transition-all hover:border-accent-primary/50 relative group pricing-card card-lift icon-list-item',
          index === popularIndex && 'border-accent-primary shadow-glow-primary scale-105'
        ]}>
          {index === popularIndex && (
            <div class="absolute -top-4 left-1/2 -translate-x-1/2 bg-gradient-primary text-white px-3 sm:px-4 py-1 rounded-full text-xs sm:text-sm font-semibold badge-pulse-once whitespace-nowrap">
              Most Popular
            </div>
          )}
          
          <h3 class="text-xl sm:text-2xl font-bold font-heading text-text-primary mb-2 break-words">{tier.name}</h3>
          <div class="mb-4">
            <span class="text-4xl sm:text-5xl font-bold font-heading gradient-text">{currencySymbol}{tier.price}</span>
          </div>
          <p class="text-text-secondary mb-6 leading-relaxed break-words">{tier.description}</p>
          
          <ul class="space-y-3 mb-6">
            {tier.features.slice(0, 5).map((feature) => (
              <li class="flex items-start">
                <svg class="w-5 h-5 text-accent-primary mr-3 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                <span class="text-text-secondary text-sm">{feature}</span>
              </li>
            ))}
          </ul>
          
          <div class="mb-8 p-3 bg-accent-primary/10 rounded-lg border border-accent-primary/20">
            <p class="text-text-secondary text-xs leading-relaxed">
              <strong class="text-text-primary">Includes 3 months of hosting.</strong> After that, hosting renews monthly.
            </p>
          </div>
          
          {tier.features.length > 5 && (
            <div class="mb-8">
              <button
                type="button"
                class="pricing-expand-button flex items-center justify-center w-full text-sm text-accent-primary hover:text-accent-primary-hover transition-colors focus:outline-none focus:ring-2 focus:ring-inset focus:ring-accent-primary"
                aria-expanded="false"
                data-tier-index={index}
              >
                <span class="expand-text">Show more features</span>
                <svg
                  class="pricing-expand-icon w-5 h-5 ml-2 transition-transform"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              <ul class="pricing-extra-features space-y-3 mt-3" style="max-height: 0; overflow: hidden; transition: max-height 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);">
                {tier.features.slice(5).map((feature) => (
                  <li class="flex items-start">
                    <svg class="w-5 h-5 text-accent-primary mr-3 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    <span class="text-text-secondary text-sm">{feature}</span>
                  </li>
                ))}
              </ul>
            </div>
          )}
          
          <div class="space-y-2">
            <button
              type="button"
              class:list={[
                'website-add-to-cart w-full py-3 px-6 rounded-lg font-semibold transition-all',
                index === popularIndex 
                  ? 'bg-accent-primary text-white hover:bg-accent-primary-hover shadow-glow-soft' 
                  : 'bg-bg-surface text-text-primary hover:bg-accent-primary hover:text-white border border-border-subtle'
              ]}
              data-package-name={tier.name}
              data-package-price={tier.price}
              data-currency-symbol={currencySymbol}
            >
              Add to cart
            </button>
            <Button 
              href={`${basePath}/${region}/contact`}
              variant="secondary"
              class="w-full"
            >
              Get started
            </Button>
          </div>
        </div>
      ))}
    </div>
  </div>
</section>

<script>
  // Pricing card expand/collapse functionality
  document.querySelectorAll('.pricing-expand-button').forEach((button) => {
    button.addEventListener('click', () => {
      const isExpanded = button.getAttribute('aria-expanded') === 'true';
      const extraFeatures = button.nextElementSibling as HTMLElement;
      const icon = button.querySelector('.pricing-expand-icon') as HTMLElement;
      const text = button.querySelector('.expand-text');
      
      if (isExpanded) {
        // Collapse
        button.setAttribute('aria-expanded', 'false');
        if (extraFeatures) extraFeatures.style.maxHeight = '0';
        if (icon) icon.style.transform = 'rotate(0deg)';
        if (text) text.textContent = 'Show more features';
      } else {
        // Expand
        button.setAttribute('aria-expanded', 'true');
        if (extraFeatures) {
          // Calculate the height needed
          const height = extraFeatures.scrollHeight;
          extraFeatures.style.maxHeight = height + 'px';
        }
        if (icon) icon.style.transform = 'rotate(180deg)';
        if (text) text.textContent = 'Show less';
      }
    });
  });
  
  // Website package add to cart functionality
  document.querySelectorAll('.website-add-to-cart').forEach((button) => {
    button.addEventListener('click', (e) => {
      e.stopPropagation();
      const btn = button as HTMLElement;
      const packageName = btn.dataset.packageName;
      const packagePrice = parseFloat(btn.dataset.packagePrice || '0');
      const currencySymbol = btn.dataset.currencySymbol;
      
      // Get existing cart data
      let cart = JSON.parse(localStorage.getItem('cart') || '[]');
      
      // Remove any existing website package
      cart = cart.filter((item: any) => item.type !== 'website');
      
      // Add new website package
      cart.push({
        type: 'website',
        name: packageName,
        price: packagePrice,
        currencySymbol: currencySymbol
      });
      
      // Save cart
      localStorage.setItem('cart', JSON.stringify(cart));
      
      // Update button text temporarily
      const originalText = button.textContent;
      button.textContent = 'Added!';
      button.classList.add('bg-green-600');
      
      setTimeout(() => {
        button.textContent = originalText;
        button.classList.remove('bg-green-600');
      }, 2000);
      
      // Trigger cart update event
      window.dispatchEvent(new Event('cartUpdated'));
    });
  });
</script>

<style>
  @media (prefers-reduced-motion: no-preference) {
    .glass {
      transition: all 0.3s ease;
    }
    
    .glass:hover {
      transform: translateY(-4px);
    }
  }
</style>
