---
import { SITE_NAME } from '../config/site';

export interface Props {
  title: string;
  description: string;
  region?: 'uk' | 'us';
  canonical?: string;
  ogImage?: string;
}

const { title, description, region, canonical, ogImage } = Astro.props;
const canonicalURL = canonical || new URL(Astro.url.pathname, Astro.site);
const imageURL = ogImage || new URL('/marketing/og-image.jpg', Astro.site);
---

<!doctype html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title} | {SITE_NAME}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalURL} />
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={`${title} | ${SITE_NAME}`} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={imageURL} />
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={canonicalURL} />
    <meta name="twitter:title" content={`${title} | ${SITE_NAME}`} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={imageURL} />
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/marketing/favicon.svg" />
    <link rel="icon" type="image/png" sizes="32x32" href="/marketing/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/marketing/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/marketing/apple-touch-icon.png" />
    <link rel="manifest" href="/marketing/site.webmanifest" />
    
    <!-- Premium Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet" />
    
    <meta name="generator" content={Astro.generator} />
    
    {region && (
      <script is:inline type="application/ld+json" set:html={JSON.stringify({
        '@context': 'https://schema.org',
        '@type': 'Organization',
        name: SITE_NAME,
        url: Astro.site,
        logo: new URL('/marketing/logo.png', Astro.site),
      })} />
    )}
  </head>
  <body class="min-h-screen bg-bg-base text-text-primary antialiased">
    <slot />
    
    <script>
      import { initSectionAnimations } from '../utils/animations';
      initSectionAnimations();
    </script>
    
    <script>
      // Region auto-detection and persistence
      if (typeof window !== 'undefined') {
        const savedRegion = localStorage.getItem('region');
        const currentPath = window.location.pathname;
        const basePath = '/marketing';
        const pathWithoutBase = currentPath.replace(basePath, '');
        
        // Only auto-redirect on homepage if no saved region
        if (pathWithoutBase === '/' || pathWithoutBase === '') {
          if (savedRegion && (savedRegion === 'uk' || savedRegion === 'us')) {
            // Use saved region preference
            window.location.href = `${basePath}/${savedRegion}`;
          } else {
            // Auto-detect region
            let detectedRegion = 'uk'; // Default to UK
            
            try {
              // Try to detect from timezone
              const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
              const language = navigator.language;
              
              // US timezones
              if (timezone && (
                timezone.includes('America/') || 
                timezone.includes('US/') ||
                timezone.includes('Pacific/Honolulu')
              )) {
                detectedRegion = 'us';
              }
              // US language codes
              else if (language && language.toLowerCase().startsWith('en-us')) {
                detectedRegion = 'us';
              }
              // UK indicators (keeping default)
              // If ambiguous or detection fails, defaults to 'uk'
            } catch (e) {
              // Detection failed, use default (uk)
              console.log('Region detection failed, using UK default');
            }
            
            // Redirect to detected region
            window.location.href = `${basePath}/${detectedRegion}`;
          }
        }
      }
    </script>
    
    <script>
      // Reduced motion support
      const mediaQuery = window.matchMedia('(prefers-reduced-motion: reduce)');
      if (mediaQuery.matches) {
        document.documentElement.style.setProperty('scroll-behavior', 'auto');
      }
    </script>
    
    <script>
      // Smooth scroll with sticky header offset
      document.addEventListener('DOMContentLoaded', () => {
        const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        
        // Don't add smooth scrolling if user prefers reduced motion
        if (prefersReducedMotion) {
          return;
        }
        
        // Handle anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
          anchor.addEventListener('click', function (this: HTMLAnchorElement, e: Event) {
            const href = this.getAttribute('href');
            if (!href || href === '#') return;
            
            e.preventDefault();
            
            const targetId = href.substring(1);
            const targetElement = document.getElementById(targetId);
            
            if (targetElement) {
              // Account for sticky header height (64px)
              const headerOffset = 80;
              const elementPosition = targetElement.getBoundingClientRect().top;
              const offsetPosition = elementPosition + window.scrollY - headerOffset;
              
              window.scrollTo({
                top: offsetPosition,
                behavior: 'smooth'
              });
            }
          });
        });
      });
    </script>
  </body>
</html>
